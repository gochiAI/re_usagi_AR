<div id="filter_buttons">
    <!--  プルダウンメニュー 1:ekimemo,2:alarm,3:lessar,0:all  -->
    <select id="Event_filter">
    </select>
    <!--　プルダウンメニュー　-->
    <select id="Character_filter">
    </select>
    <button class="close_add_sprite">閉じる</button>
</div>

<div id="Sprites_List">
</div>
<button class="close_add_sprite">閉じる</button>
<script>
    class LocalStorageUtility {
        getStorage(key = null) {
            const data = JSON.parse(localStorage.getItem('sprites_config')) || {};
            return key ? data[key] : data;
        }

        setStorage(key, value) {
            const data = this.getStorage();
            data[key] = value;
            localStorage.setItem('sprites_config', JSON.stringify(data));
        }

        removeData(key) {
            const data = this.getStorage();
            delete data[key];
        }

        getAllKeys() {
            return Object.keys(this.getStorage());
        }
    }
    class get_src {
        sprite_ID(sprite_name) {
            if (sprite_name.endsWith("_0")) {
                sprite_name = sprite_name.replace("_0", ".png");
            } else {
                sprite_name = sprite_name + '.png';
            }
            return sprite_name;
        }

        get_stand_src(sprite_name) {
            return `./core_sys/img/stand_sprites/${this.sprite_ID(sprite_name)}`;
        }

        get_thumb_src(sprite_name) {
            return `./core_sys/img/thumb_sprites/${this.sprite_ID(sprite_name)}`;
        }

        get_stand_size(sprite_name) {
            return new Promise((resolve, reject) => {
                var src = this.get_stand_src(sprite_name);
                var img = new Image();
                img.src = src;
                img.onload = function () {
                    var width = img.width;
                    var height = img.height;
                    resolve([width, height]);
                }
                img.onerror = function () {
                    img.src = './path_to_your_404_image.png'; // Add this line
                    reject('Image not found');
                }
            });
        }
    }

    var CharacterDatas = ["alarm/chino_0", "alarm/chiya_0", "alarm/cocoa_0", "alarm/rize_0", "alarm/syaro_0",
        "lessar/chino_0", "lessar/chiya_0", "lessar/cocoa_0", "lessar/rize_0", "lessar/syaro_0", "lessar/maya_0", "lessar/megu_0", "lessar/fuyu_0",
        "ekimemo/chino_usual", "ekimemo/chino_smile", "ekimemo/chino_angry", "ekimemo/chino_dovey", "ekimemo/chino_tired",
        "ekimemo/chiya_usual", "ekimemo/chiya_smile", "ekimemo/chiya_angry", "ekimemo/chiya_dovey", "ekimemo/chiya_tired",
        "ekimemo/cocoa_usual", "ekimemo/cocoa_smile", "ekimemo/cocoa_angry", "ekimemo/cocoa_dovey", "ekimemo/cocoa_tired",
        "ekimemo/rize_usual", "ekimemo/rize_smile", "ekimemo/rize_angry", "ekimemo/rize_dovey", "ekimemo/rize_tired",
        "ekimemo/syaro_usual", "ekimemo/syaro_smile", "ekimemo/syaro_angry", "ekimemo/syaro_dovey", "ekimemo/syaro_tired",
        "ekimemo/maya_usual", "ekimemo/maya_smile", "ekimemo/maya_angry", "ekimemo/maya_dovey", "ekimemo/maya_tired",
        "ekimemo/megu_usual", "ekimemo/megu_smile", "ekimemo/megu_angry", "ekimemo/megu_dovey", "ekimemo/megu_tired",
    ];

    var CopilotLS = new LocalStorageUtility();
    const events = ['全て', 'ekimemo', 'alarm', 'lessar'];
    const characters = ['全て', 'chino', 'cocoa', 'rize', 'chiya', 'syaro', 'maya', 'megu', 'fuyu'];

    const eventFilter = document.getElementById('Event_filter');
    const characterFilter = document.getElementById('Character_filter');

    events.forEach((event) => {
        const option = document.createElement('option');
        option.value = event;
        option.text = event;
        eventFilter.appendChild(option);
    });
    characters.forEach((character) => {
        const option = document.createElement('option');
        option.value = character;
        option.text = character;
        characterFilter.appendChild(option);
    });
    function filterList() {
        const selectedEvent = eventFilter.value;
        const selectedCharacter = characterFilter.value;
        const filterList = CharacterDatas.filter(sprite_name => {
            if (selectedEvent === "全て" && selectedCharacter === "全て") return true;
            if (selectedEvent !== "全て" && selectedCharacter === "全て") return sprite_name.includes(selectedEvent);
            if (selectedEvent === "全て" && selectedCharacter !== "全て") return sprite_name.includes(selectedCharacter);
            return sprite_name.includes(selectedEvent) && sprite_name.includes(selectedCharacter);
        });

        parentDiv.innerHTML = '';
        displayCh(filterList);
    }

    function createButton(iconSrc, onClick) {
        const button = document.createElement('button');
        const icon = document.createElement('img');
        icon.src = iconSrc;
        button.appendChild(icon);
        button.onclick = onClick;
        return button;
    }

    function displayCh(CharacterDatas) {
        CharacterDatas.forEach(sprite_name => {
            const newDiv = document.createElement('div');
            newDiv.classList.add("SpriteCard");

            const img = document.createElement('img');
            img.src = new get_src().get_thumb_src(sprite_name);

            newDiv.appendChild(img);

            const CardButtons = document.createElement('div');
            CardButtons.id = "CardButtons";

            const imgZoom_Button = createButton("./core_sys/img/ui/img_zoom.svg", function () {
                const Img_Modal = document.createElement('div');
                Img_Modal.id = "Img_Modal";
                Img_Modal.onclick = function () { Img_Modal.remove(); };
                const img = document.createElement('img');
                img.src = new get_src().get_stand_src(sprite_name);
                Img_Modal.appendChild(img);
                document.body.appendChild(Img_Modal);
            });

            const selectSprite_Button = createButton(CopilotLS.getStorage(sprite_name) ? "./core_sys/img/ui/user_remove.svg" : "./core_sys/img/ui/user_add.svg", function () {
                const selectSprite_icon = this.firstChild; // Add this line
                if (newDiv.classList.contains('selected')) {
                    selectSprite_icon.src = "./core_sys/img/ui/user_add.svg";
                    CopilotLS.removeData(sprite_name);
                    newDiv.classList.remove('selected');
                } else {
                    selectSprite_icon.src = "./core_sys/img/ui/user_remove.svg";
                    CopilotLS.setStorage(sprite_name, { "X": 0, "Y": 0, "ZoomRate": 1.0 });
                    newDiv.classList.add('selected');
                }
            });

            if (CopilotLS.getStorage(sprite_name)) newDiv.classList.add('selected');

            CardButtons.appendChild(imgZoom_Button);
            CardButtons.appendChild(selectSprite_Button);
            newDiv.appendChild(CardButtons);

            parentDiv.appendChild(newDiv);
        });
    }

    let parentDiv = document.querySelector('#Sprites_List');


    eventFilter.addEventListener('change', filterList);
    characterFilter.addEventListener('change', filterList);

    displayCh(CharacterDatas);
</script>
<style>
    #Sprites_List {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap
    }

    .SpriteCard {
        border: 4px solid #000;
        width: 150px;
        height: 150px;
        margin: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }

    .SpriteCard.selected {
        border: 4px dashed blue;
    }

    .SpriteCard img {
        width: 80%;
        height: 80%;
        object-fit: cover;
    }

    .close_add_sprite {
        /*画面中央*/
        position: relative;
        left: 50%;
    }

    #CardButtons {
        position: absolute;
        bottom: 5px;
    }

    #CardButtons button {
        margin: 0px 5px;
    }

    #Img_Modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.5);
        display: flex;

        justify-content: center;
        align-items: center;
    }

    #Img_Modal img {
        width: auto;
        height: 80%;
    }
</style>