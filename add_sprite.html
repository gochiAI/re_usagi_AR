<div id="filter_buttons">
    <!--  プルダウンメニュー 1:ekimemo,2:alarm,3:lessar,0:all  -->
    <select id="Event_filter">
        <option value="ev-0">全て</option>
        <option value="ev-ekimemo">ekimemo</option>
        <option value="ev-alarm">alarm</option>
        <option value="ev-lessar">lessar</option>
    </select>
    <!--　プルダウンメニュー　-->
    <select id="Character_filter">
        <option value="ch-0">全て</option>
        <option value="ch-chino">chino</option>
        <option value="ch-cocoa">cocoa</option>
        <option value="ch-rize">rize</option>
        <option value="ch-chiya">chiya</option>
        <option value="ch-syaro">syaro</option>
        <option value="ch-maya">maya</option>
        <option value="ch-megu">megu</option>
        <option value="ch-fuyu">fuyu</option>
    </select>
    <button class="close_add_sprite">閉じる</button>
</div>


<div id="Sprites_List">
</div>
<button class="close_add_sprite">閉じる</button>
<script>
    class LocalStorageUtility {
        //一つのローカルストレージにすべてのデータを保存する
        //データはJSON形式で保存されるため、JSON.parse()で取り出す
        getStorage = function () {
            return JSON.parse(localStorage.getItem('sprites_config')) || {};
        }
        setStorage = function (data) {
            localStorage.setItem('sprites_config', JSON.stringify(data));
        }

        //データを保存する
        saveData(key, value) {
            let data = this.getStorage();
            //setdefaultのような動きをする
            data[key]=value;
            this.setStorage(data);
        }
        //データを取得する
        getData(key) {
            let data = this.getStorage();
            return data[key];
        }
        //データを削除する
        removeData(key){
            let data = this.getStorage();
            delete data[key];
            this.setStorage(data);
        }
    }
    // リストデータを取得します
    var CharacterDatas = ["alarm/chino_0", "alarm/chiya_0", "alarm/cocoa_0", "alarm/rize_0", "alarm/syaro_0",
        "lessar/chino_0", "lessar/chiya_0", "lessar/cocoa_0", "lessar/rize_0", "lessar/syaro_0", "lessar/maya_0", "lessar/megu_0", "lessar/fuyu_0",
        "ekimemo/chino_usual", "ekimemo/chino_smile", "ekimemo/chino_angry", "ekimemo/chino_dovey", "ekimemo/chino_tired",
        "ekimemo/chiya_usual", "ekimemo/chiya_smile", "ekimemo/chiya_angry", "ekimemo/chiya_dovey", "ekimemo/chiya_tired",
        "ekimemo/cocoa_usual", "ekimemo/cocoa_smile", "ekimemo/cocoa_angry", "ekimemo/cocoa_dovey", "ekimemo/cocoa_tired",
        "ekimemo/rize_usual", "ekimemo/rize_smile", "ekimemo/rize_angry", "ekimemo/rize_dovey", "ekimemo/rize_tired",
        "ekimemo/syaro_usual", "ekimemo/syaro_smile", "ekimemo/syaro_angry", "ekimemo/syaro_dovey", "ekimemo/syaro_tired",
        "ekimemo/maya_usual", "ekimemo/maya_smile", "ekimemo/maya_angry", "ekimemo/maya_dovey", "ekimemo/maya_tired",
        "ekimemo/megu_usual", "ekimemo/megu_smile", "ekimemo/megu_angry", "ekimemo/megu_dovey", "ekimemo/megu_tired",
    ];

    var CopilotLS = new LocalStorageUtility();

    // 親div要素を取得します
    let parentDiv = document.querySelector('#Sprites_List');
    var eventFilter = document.getElementById('Event_filter');
    var characterFilter = document.getElementById('Character_filter');

    // プルダウンメニューのchangeイベントにリスナーを追加
    eventFilter.addEventListener('change', filterList);
    characterFilter.addEventListener('change', filterList);

    var get_img_src = function (sprite_name) {
        // sprite_nameが*/0で終わっている場合は/0を.pngに置換する
        if (sprite_name.endsWith("_0")) {
            sprite_name = sprite_name.replace("_0", ".png");
        } else {
            // 二番目のスラッシュをアンダーバーに置換する
            sprite_name = sprite_name + '.png';
        }
        return sprite_name;
    }
    //selectデータの変更時にリストを再描画する
    function filterList() {
        // 選択されたオプションの値を取得
        var selectedEvent = eventFilter.value;
        var selectedCharacter = characterFilter.value;
        // Sprites_Listの子要素を全て削除
        while (parentDiv.firstChild) {
            parentDiv.removeChild(parentDiv.firstChild);
        }
        // フィルター値に応じてリストを再作成
        var filterList = CharacterDatas.filter(
            function (sprite_name) {
                //両方とも0,0なら何もしない
                if (selectedEvent == "ev-0" && selectedCharacter == "ch-0") {
                    return true;
                }
                //それ以外の場合は-以降の文字列を取得
                else {
                    let event = selectedEvent.split('-')[1];
                    let character = selectedCharacter.split('-')[1];

                    //イベントが0以外の場合はイベントが一致するものだけを表示
                    if (event != "0" && character == "0") {

                        return sprite_name.includes(event);
                    }
                    //キャラクターが0以外の場合はキャラクターが一致するものだけを表示
                    else if (event == "0" && character != "0") {
                        return sprite_name.includes(character);
                    }
                    //両方とも0以外の場合は両方が一致するものだけを表示
                    else {
                        return sprite_name.includes(event) && sprite_name.includes(character);
                    }
                }
            });
        displayCh(filterList);
    }

    function displayCh(CharacterDatas) {
        for (let i = 0; i < CharacterDatas.length; i++) {
            // 新しいdiv要素を作成します
            let newDiv = document.createElement('div');


            // 作成したdiv要素に"SpriteCard"というクラスを追加します
            newDiv.classList.add("SpriteCard");
            let img = document.createElement('img');
            img.src = "./core_sys/img/thumb_sprites/" + get_img_src(CharacterDatas[i]);
            let sprite_name = CharacterDatas[i];
            newDiv.appendChild(img);
            let CardButtons = document.createElement('div');
            CardButtons.id = "CardButtons";
            let imgZoom_Button = document.createElement('button');
            let imgZoom_icon = document.createElement('img');
            imgZoom_icon.src = "./core_sys/img/ui/img_zoom.svg";
            imgZoom_Button.appendChild(imgZoom_icon)
            imgZoom_Button.onclick = function () {
                let Img_Modal = document.createElement('div');
                Img_Modal.id = "Img_Modal";

                Img_Modal.onclick = function () {
                    //Img_Modalを削除
                    Img_Modal.remove();
                };

                let img = document.createElement('img');
                img.src = "./core_sys/img/stand_sprites/" + get_img_src(CharacterDatas[i]);
                Img_Modal.appendChild(img);
                document.body.appendChild(Img_Modal);

            };

            let selectSprite_Button = document.createElement('button');
            let selectSprite_icon = document.createElement('img');
            selectSprite_icon.src = "./core_sys/img/ui/user_add.svg";
            selectSprite_Button.appendChild(selectSprite_icon);
            //すでにlocalStorageにデータがある場合はselectedクラスを追加
            if (CopilotLS.getData(sprite_name)) {
                newDiv.classList.add('selected');
                selectSprite_icon.src = "./core_sys/img/ui/user_remove.svg";
            }
            selectSprite_Button.onclick = function () {
                //選択/非選択の切り替えをボタンを押すごとに行う
                //選択されているときには親の親のdiv要素にselectedクラスを追加する
                if (newDiv.classList.contains('selected')) {
                    selectSprite_icon.src = "./core_sys/img/ui/user_add.svg";
                    CopilotLS.removeData(sprite_name);
                    newDiv.classList.remove('selected');
                } else {
                    selectSprite_icon.src = "./core_sys/img/ui/user_remove.svg";
                    CopilotLS.saveData(sprite_name, {
                        "X": 0,
                        "Y": 0,
                        "ZoomRate": 1.0
                    });
                    newDiv.classList.add('selected');
                }

            };
            // 作成したdiv要素を親div要素に追加します
            CardButtons.appendChild(imgZoom_Button);
            CardButtons.appendChild(selectSprite_Button);
            newDiv.appendChild(CardButtons);

            parentDiv.appendChild(newDiv);
        }
    }
    displayCh(CharacterDatas);
</script>
<style>
    #Sprites_List {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap
    }

    .SpriteCard {
        border: 4px solid #000;
        width: 150px;
        height: 150px;
        margin: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }

    .SpriteCard.selected {
        border: 4px dashed blue;
    }

    .SpriteCard img {
        width: 80%;
        height: 80%;
        object-fit: cover;
    }

    .close_add_sprite {
        /*画面中央*/
        position: relative;
        left: 50%;
    }

    #CardButtons {
        position: absolute;
        bottom: 5px;
    }

    #CardButtons button {
        margin: 0px 5px;
    }

    #Img_Modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.5);
        display: flex;

        justify-content: center;
        align-items: center;
    }

    #Img_Modal img {
        width: auto;
        height: 80%;
    }
</style>